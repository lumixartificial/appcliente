<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LUMIX Cliente">
    <meta name="theme-color" content="#6f42c1">
    <link rel="manifest" href="manifest-cliente.json">
    <link rel="icon" href="https://res.cloudinary.com/dc6as14p0/image/upload/v1759873183/LOGO_LUMIX_REDUCI_czkw4p.png" type="image/png">
    <link rel="apple-touch-icon" href="https://res.cloudinary.com/dc6as14p0/image/upload/v1759873183/LOGO_LUMIX_REDUCI_czkw4p.png">
    <title>Portal do Cliente</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <style>
        :root {
            --bg: #f8f9fa;
            --surface: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-green: #28a745;
            --accent-yellow: #facc15;
            --accent-orange: #fb923c;
            --accent-purple: #6f42c1;
            --accent-purple-darker: #5a349c;
            --border-color: #e9ecef;
            --danger-color: #dc3545;
        }
        body.dark-mode {
            --bg: #020617;
            --surface: #0f172a;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #1e293b;
            --danger-color: #f87171;
            --accent-yellow: #fde047;
            --accent-orange: #fdba74;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden; 
            width: 100%;
            height: 100%; 
            height: -webkit-fill-available;
            height: 100dvh;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.9; }
        }

        @keyframes subtle-glow {
          0%, 100% {
            filter: drop-shadow(0 0 8px rgba(138, 43, 226, 0.7));
          }
          50% {
            filter: drop-shadow(0 0 16px rgba(57, 255, 20, 0.7));
          }
        }

        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease-out;
        }
        #splash-screen img {
            width: 150px; 
            height: 150px; 
            animation: pulse 2.5s infinite ease-in-out;
        }

        #login-view {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 20px;
            background-color: var(--bg);
        }
        .login-card {
            background-color: transparent;
            box-shadow: none;
            border: none;
            width: 100%; max-width: 400px; text-align: center;
        }
        .login-card .logo {
            display: flex;
            justify-content: center;
        }
        .login-card .logo img {
            width: 140px; 
            height: 140px; 
            margin-bottom: 30px; 
            animation: subtle-glow 5s ease-in-out infinite;
        }
        .login-card h2 {
            margin-bottom: 10px;
            font-size: 1.8em; 
            font-weight: 700;
            color: var(--text-primary);
        }
        .login-card p {
            margin-bottom: 40px;
            color: var(--text-secondary);
        }
        .login-card .form-group {
            text-align: left;
            margin-bottom: 20px;
        }
        .login-card .form-group label {
             display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary);
        }
        .login-card .form-group input { 
            width: 100%; 
            padding: 15px; 
            font-size: 1em; 
            border-radius: 8px; 
            border: 1px solid #334155; 
            background-color: #1e293b; 
            color: var(--text-primary); 
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .login-card .form-group input:focus {
            border-color: var(--accent-purple);
            outline: none;
            box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.3);
        }

        .login-card .btn-primary {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--accent-purple);
            color: white;
            transition: background-color 0.2s;
        }
        .login-card .btn-primary:hover {
            background-color: var(--accent-purple-darker);
        }

        #app-container { 
            display: none;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 100%;
            height: -webkit-fill-available;
            height: 100dvh;
        }
        main {
            flex-grow: 1; 
            overflow-y: auto; 
        }
        .container { padding: 20px; }
        
        .main-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--surface); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; transition: background-color 0.3s, border-color 0.3s; flex-shrink: 0; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo img { height: 40px; width: 40px; object-fit: cover; }
        .logo-text { font-size: 1.2em; font-weight: 700; color: var(--text-primary); }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .header-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 5px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; }
        #header-profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }
        .profile {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .profile-info {
            font-weight: 500;
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        .lang-dropdown { 
            display: none; 
            position: absolute; 
            top: 55px; 
            right: 10px; 
            background-color: var(--surface); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            z-index: 110; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 5px;
            width: 150px;
        }
        .lang-dropdown button { 
            background-color: transparent; 
            border: none; 
            color: var(--text-primary); 
            padding: 8px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 500; 
            width: 100%;
            text-align: left;
            box-shadow: none;
        }
        .lang-dropdown button:hover { background-color: var(--border-color); }
        .section-title { font-size: 1.2em; font-weight: 600; margin-bottom: 15px; color: var(--text-primary); }
        .kpi-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        .kpi-card { background-color: var(--surface); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s; }
        body.dark-mode .kpi-card { box-shadow: none; }
        .kpi-title { display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: var(--text-secondary); margin: 0 0 10px; }
        .kpi-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            white-space: nowrap;
        }
        .kpi-value.green { color: var(--accent-green); }
        .kpi-value.purple { color: var(--accent-purple); }

        .progress-card { text-align: center; }
        .progress-circle { position: relative; width: 120px; height: 120px; margin: 0 auto 15px; }
        .progress-circle svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .progress-circle circle { fill: none; stroke-width: 10; }
        .progress-circle .bg-circle { stroke: var(--border-color); }
        .progress-circle .progress-bar { stroke: var(--accent-purple); stroke-linecap: round; transition: stroke-dashoffset 1s ease-out; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5em; font-weight: 700; }
        
        .reputation-card { padding-bottom: 10px; }
        .reputation-bar-container { width: 100%; background-color: var(--border-color); border-radius: 8px; height: 16px; overflow: hidden; margin-bottom: 10px; }
        .reputation-bar { height: 100%; border-radius: 8px; width: 0%; transition: width 1s ease-out, background-color 0.5s; }
        .reputation-bar.status-perfect { background-color: var(--accent-green); }
        .reputation-bar.status-good { background-color: var(--accent-orange); }
        .reputation-bar.status-regular { background-color: var(--accent-yellow); }
        .reputation-bar.status-bad { background-color: var(--danger-color); }
        .reputation-status { display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .reputation-value { font-weight: 700; }
        .reputation-text { font-weight: 500; padding: 2px 8px; border-radius: 10px; }
        .reputation-text.status-perfect { color: var(--accent-green); background-color: rgba(40, 167, 69, 0.1); }
        .reputation-text.status-good { color: #b45309; background-color: rgba(251, 146, 60, 0.15); }
        body.dark-mode .reputation-text.status-good { color: var(--accent-orange); background-color: rgba(253, 186, 116, 0.1); }
        .reputation-text.status-regular { color: #856404; background-color: rgba(250, 204, 21, 0.15); }
        body.dark-mode .reputation-text.status-regular { color: var(--accent-yellow); background-color: rgba(253, 224, 71, 0.1); }
        .reputation-text.status-bad { color: var(--danger-color); background-color: rgba(220, 53, 69, 0.1); }
        .reputation-info { font-size: 0.8em; color: var(--text-secondary); margin-top: 15px; text-align: center; }


        .section-title { font-size: 1.3em; font-weight: 600; margin-bottom: 20px; border-bottom: 2px solid var(--accent-purple); padding-bottom: 10px; }
        .payment-history-list { display: flex; flex-direction: column; gap: 10px; }
        .payment-history-item { display: flex; justify-content: space-between; align-items: flex-start; background-color: var(--surface); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; }
        .payment-info { flex-grow: 1; margin-right: 10px; }
        .payment-title { font-weight: 600; margin: 0 0 5px; font-size: 1em; }
        .payment-description { font-size: 0.9em; color: var(--text-secondary); margin: 0 0 8px; line-height: 1.4; }
        .payment-date { color: var(--text-secondary); font-size: 0.8em; }
        .payment-amount { font-weight: 600; }
        .payment-status-wrapper { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; text-align: right; }
        .payment-status-tag { font-size: 0.75em; font-weight: 500; padding: 3px 8px; border-radius: 10px; }
        .payment-status-tag.pending { background-color: rgba(250, 204, 21, 0.15); color: #856404; }
        .payment-status-tag.approved { background-color: rgba(40, 167, 69, 0.1); color: var(--accent-green); }
        body.dark-mode .payment-status-tag.pending { background-color: rgba(253, 224, 71, 0.1); color: var(--accent-yellow); }
        body.dark-mode .payment-status-tag.approved { background-color: rgba(40, 167, 69, 0.2); }
        .no-history { color: var(--text-secondary); text-align: center; padding: 20px; }

        .loan-tabs-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px; /* For the scroll bar */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .loan-tabs-container::-webkit-scrollbar { display: none; } /* Chrome, Safari, Opera */
        .loan-tab {
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--surface);
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease-in-out;
        }
        .loan-tab.active {
            background-color: var(--accent-purple);
            color: white;
            border-color: var(--accent-purple);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(111, 66, 193, 0.3);
        }

        .bottom-nav { position: static; flex-shrink: 0; background-color: var(--surface); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: calc(10px + env(safe-area-inset-bottom)); box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05); transition: background-color 0.3s, border-color 0.3s; z-index: 150; }
        body.dark-mode .bottom-nav { box-shadow: none; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--text-secondary); text-decoration: none; font-size: 0.8em; padding: 5px 15px; cursor: pointer; }
        .nav-item.active { color: var(--accent-purple); }
        .nav-item.disabled { opacity: 0.5; cursor: not-allowed; }
        
        .view { display: none; }
        .view.active { display: block; }

        .profile-pic-wrapper { position: relative; cursor: pointer; }
        .profile-pic-wrapper::after { content: '✎'; position: absolute; bottom: 5px; right: 5px; background-color: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .profile-pic-wrapper img.loading { opacity: 0.5; }
        #profile-view-img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent-purple); object-fit: cover; }
        
        .settings-item { display: flex; align-items: center; gap: 15px; background-color: var(--surface); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 500; text-decoration: none; color: var(--text-primary); }
        .settings-item.logout { color: var(--danger-color); }
        .settings-item.logout i { color: var(--danger-color); }

        .modal-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg); z-index: 200; transform: translateX(100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
        .modal-view.active { transform: translateX(0); }
        .modal-header { display: flex; align-items: center; padding: 15px 20px; background-color: var(--surface); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 210; flex-shrink: 0; }
        .modal-header button { background: none; border: none; color: var(--text-primary); cursor: pointer; padding: 0; margin-right: 15px; }
        .modal-title { font-size: 1.2em; font-weight: 600; }
        .modal-content-wrapper { flex-grow: 1; overflow-y: auto; }
        .action-buttons { background-color: var(--surface); border-top: 1px solid var(--border-color); padding: 15px 20px; padding-bottom: calc(15px + env(safe-area-inset-bottom)); display: flex; gap: 15px; margin-top: auto; position: sticky; bottom: 0; flex-shrink: 0; }
        .action-buttons button { flex-grow: 1; padding: 15px; font-size: 1em; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        
        .btn-primary {
            background-color: var(--accent-purple);
            color: white;
            padding: 15px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-secondary { background-color: var(--bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9em; font-weight: 500; color: var(--text-secondary); }
        .form-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--surface); color: var(--text-primary); }

        #cropper-container { height: calc(100% - 150px); }
        #cropper-container img { max-width: 100%; height: auto; }
        
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast { background-color: #333; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 0.9em; opacity: 0; transform: translateY(-20px); transition: opacity 0.3s, transform 0.3s; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.toast-error { background-color: var(--danger-color); }

        #pix-qr-code { max-width: 200px; margin: 10px auto; display: block; border-radius: 8px; }
        #pix-copy-paste-code { width: 100%; padding: 10px; border-radius: 8px; background-color: var(--border-color); border: none; font-family: monospace; font-size: 0.9em; resize: none; }
        .upload-receipt-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px dashed var(--border-color); padding: 20px; border-radius: 12px; cursor: pointer; text-align: center; }
        #receipt-preview { max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 8px; }
        
        .notification-badge { 
            position: absolute; top: 12px; right: 12px; width: 10px; height: 10px; background-color: var(--danger-color); border-radius: 50%; border: 2px solid var(--surface); 
        }
        .bottom-nav .nav-item { position: relative; }
        .bottom-nav .notification-badge { top: 3px; right: 10px; }
        
        .notifications-list { display: flex; flex-direction: column; gap: 10px; }
        .notification-item { display: flex; gap: 15px; background-color: var(--surface); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent-purple); cursor: pointer; }
        .notification-item.unread { background-color: color-mix(in srgb, var(--accent-purple) 8%, var(--surface)); }
        .notification-icon { color: var(--accent-purple); flex-shrink: 0; margin-top: 3px; }
        .notification-content { flex-grow: 1; }
        .notification-title { font-weight: 600; margin: 0 0 5px; }
        .notification-body { font-size: 0.9em; color: var(--text-secondary); margin: 0; line-height: 1.5; }
        .notification-date { font-size: 0.8em; color: var(--text-secondary); margin-top: 8px; text-align: right; }
        .no-notifications { color: var(--text-secondary); text-align: center; padding: 20px; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="install-banner" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: calc(100% - 40px); max-width: 380px; background-color: var(--surface); color: var(--text-primary); padding: 25px; border-radius: 16px; z-index: 5000; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid var(--border-color); text-align: center;">

    <button id="close-install-banner" style="position: absolute; top: 15px; right: 15px; background: transparent; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer; line-height: 1; padding: 0;">&times;</button>

    <img src="https://res.cloudinary.com/dc6as14p0/image/upload/v1759873183/LOGO_LUMIX_REDUCI_czkw4p.png" alt="App Icon" style="width: 64px; height: 64px; margin-bottom: 15px;">

    <h3 style="margin: 0 0 8px; font-size: 1.2em; font-weight: 600;" data-lang-key="installAppTitle">Instale nosso aplicativo</h3>

    <p style="margin: 0 0 25px; font-size: 0.9em; color: var(--text-secondary); line-height: 1.5;" data-lang-key="installAppMsg">Uma experiência mais rápida e completa.</p>

    <button id="install-btn" style="background-color: var(--accent-purple); color: white; border: none; padding: 14px; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; font-size: 1em;" data-lang-key="installBtn">Instalar</button>

</div>

    <div id="splash-screen">
        <img id="splash-logo" src="https://res.cloudinary.com/dc6as14p0/image/upload/v1759611967/LOGO---LUMIX-FINANZAS-REDUCIDO_gc8zow.png" alt="Logo">
    </div>

    <div id="login-view">
        <div class="login-card">
            <div class="logo">
                <img id="login-logo" src="https://res.cloudinary.com/dc6as14p0/image/upload/v1759611967/LOGO---LUMIX-FINANZAS-REDUCIDO_gc8zow.png" alt="Logo">
            </div>
            <h2 data-lang-key="welcome"></h2>
            <p data-lang-key="welcomeMsg"></p>
            <form id="login-form">
                <div class="form-group">
                    <label for="username" data-lang-key="username"></label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password" data-lang-key="password"></label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-primary" data-lang-key="loginBtn"></button>
            </form>
        </div>
    </div>

    <div id="app-container">
        <header class="main-header">
            <div class="logo">
                <img id="header-logo" src="https://res.cloudinary.com/dc6as14p0/image/upload/v1759611967/LOGO---LUMIX-FINANZAS-REDUCIDO_gc8zow.png" alt="Logo da Empresa">
                <span class="logo-text" data-lang-key="appTitle"></span>
            </div>
            <div class="header-controls">
                <div style="position: relative;">
                    <button class="header-btn" id="lang-toggle"><i data-lucide="globe"></i></button>
                    <div class="lang-dropdown" id="lang-dropdown" style="display: none;"><button data-lang="pt">Português</button><button data-lang="es">Español</button><button data-lang="en">English</button></div>
                </div>
                <button class="header-btn" id="theme-toggle"><i data-lucide="moon"></i></button>
                <div class="profile" id="header-profile-link" style="cursor: pointer;">
                    <img id="header-profile-img" src="" alt="Foto do Cliente">
                </div>
            </div>
        </header>
        <main>
            <div id="home-view" class="view active container">
                <div id="loan-tabs-container" class="loan-tabs-container"></div>
                <div class="kpi-card progress-card" style="margin-bottom: 20px;">
                    <h3 class="kpi-title" style="justify-content: center;" data-lang-key="loanProgress"></h3>
                    <div class="progress-circle">
                        <svg><circle class="bg-circle" cx="60" cy="60" r="54"></circle><circle id="progress-bar" class="progress-bar" cx="60" cy="60" r="54" style="stroke-dasharray: 339.292;"></circle></svg>
                        <div class="progress-text" id="progress-text"></div>
                    </div>
                </div>
                
                <div id="reputation-card" class="kpi-card reputation-card">
                   <h3 class="kpi-title" data-lang-key="reputationScore"></h3>
                   <div class="reputation-bar-container">
                       <div id="reputation-bar" class="reputation-bar"></div>
                   </div>
                   <div class="reputation-status">
                       <span id="reputation-value" class="reputation-value"></span>
                       <span id="reputation-text" class="reputation-text"></span>
                   </div>
                   <p class="reputation-info" data-lang-key="reputationInfo"></p>
                </div>

                <div class="kpi-grid" style="margin-top: 20px;">
                    <div class="kpi-card"><h3 class="kpi-title"><i data-lucide="coins"></i><span data-lang-key="totalValue"></span></h3><p class="kpi-value" id="total-value"></p></div>
                    <div class="kpi-card"><h3 class="kpi-title"><i data-lucide="dollar-sign"></i><span data-lang-key="remainingValue"></span></h3><p class="kpi-value purple" id="remaining-value"></p></div>
                     <div class="kpi-card"><h3 class="kpi-title"><i data-lucide="receipt"></i><span data-lang-key="installmentValue"></span></h3><p class="kpi-value purple" id="kpi-installment-value"></p></div>
                </div>
                <section><h2 class="section-title" data-lang-key="paymentHistory"></h2><div id="payment-history-list" class="payment-history-list"></div></section>
            </div>
            <div id="pay-view" class="view container">
                <h2 class="section-title" data-lang-key="payInstallment"></h2>
                <div class="kpi-card" style="margin-bottom: 20px;">
                    <h3 class="kpi-title" data-lang-key="qrCodePayment"></h3>
                    <img id="pix-qr-code" src="https://placehold.co/200x200/eee/ccc?text=Loading..." alt="PIX QR Code">
                    <textarea id="pix-copy-paste-code" rows="3" readonly></textarea>
                    <button class="btn-primary" id="copy-pix-code-btn" style="width:100%; margin-top:10px;"><i data-lucide="copy"></i> <span data-lang-key="copyCode"></span></button>
                </div>
                <div class="kpi-card" style="margin-bottom: 20px;">
                     <h3 class="kpi-title" data-lang-key="manualPayment"></h3>
                     <p data-lang-key="manualPixKey"></p>
                     <div style="display:flex; gap:10px; align-items:center;">
                         <strong id="manual-pix-key-value" style="background-color: var(--border-color); padding: 10px; border-radius: 8px; flex-grow:1; text-align: center;"></strong>
                         <button class="btn-primary" id="copy-manual-key-btn" style="flex-shrink:0;"><i data-lucide="copy"></i></button>
                     </div>
                </div>
                 <div class="kpi-card">
                    <h3 class="kpi-title" data-lang-key="uploadReceipt"></h3>
                    <div class="form-group">
                        <label for="receipt-amount" data-lang-key="paymentAmountLabel"></label>
                        <input type="number" id="receipt-amount" step="0.01" placeholder="0.00" class="form-control">
                    </div>
                     <label for="receipt-file-input" class="upload-receipt-btn">
                         <i data-lucide="upload-cloud"></i>
                         <span id="upload-label-text">Clique para anexar</span>
                         <img id="receipt-preview" style="display:none;">
                     </label>
                     <input type="file" id="receipt-file-input" accept="image/*" style="display:none;">
                     <button class="btn-primary" id="submit-receipt-btn" style="width:100%; margin-top:15px;" disabled><i data-lucide="send"></i> <span data-lang-key="submitForVerification"></span></button>
                 </div>
            </div>
            <div id="refinance-view" class="view container"></div>
            <div id="notifications-view" class="view container">
                <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span data-lang-key="notificationsTitle"></span>
                    <button id="clear-notifications-btn" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size: 0.8em; font-weight: 500; display:flex; align-items:center; gap: 4px;">
                        <i data-lucide="trash-2" style="width:14px; height:14px;"></i>
                        <span data-lang-key="clearNotifications"></span>
                    </button>
                </div>
                <div id="notifications-list" class="notifications-list"></div>
            </div>
            <div id="profile-view" class="view container">
                <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 30px;">
                   <label for="profile-pic-input" class="profile-pic-wrapper">
                       <img id="profile-view-img" src="" alt="Foto do Cliente">
                   </label>
                   <input type="file" id="profile-pic-input" accept="image/*" style="display: none;">
                   <h2 id="profile-view-name" style="margin: 15px 0 0; font-size: 1.5em;"></h2>
                </div>
                <section>
                   <h2 class="section-title" data-lang-key="settings"></h2>
                   <div style="display: flex; flex-direction: column; gap: 15px;">
                       <a class="settings-item" id="test-push-btn" style="color: var(--accent-orange);"><i data-lucide="send"></i><span>Test Push Notification</span></a>
                       <a class="settings-item logout" id="logout-btn"><i data-lucide="log-out"></i><span data-lang-key="logout"></span></a>
                   </div>
                </section>
            </div>
        </main>
        <nav class="bottom-nav">
            <a class="nav-item active" data-view="home"><i data-lucide="layout-dashboard"></i><span data-lang-key="navDashboard"></span></a>
            <a class="nav-item" data-view="pay"><i data-lucide="dollar-sign"></i><span data-lang-key="navPay"></span></a>
            <a class="nav-item" data-view="refinance"><i data-lucide="trending-up"></i><span data-lang-key="navRefinance"></span></a>
            <a class="nav-item" data-view="notifications"><i data-lucide="bell"></i><span data-lang-key="navNotifications"></span><span class="notification-badge" style="display: none;"></span></a>
        </nav>
    </div>

    <div id="cropperModal" class="modal-view"></div>
    <div id="toast-container"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, onSnapshot, updateDoc, arrayUnion, serverTimestamp, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-messaging.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBRxJjpH6PBi-GRxOXS8klv-8v91sO4X-Y",
            authDomain: "lumix-financas-app.firebaseapp.com",
            projectId: "lumix-financas-app",
            storageBucket: "lumix-financas-app.appspot.com",
            messagingSenderId: "463777495321",
            appId: "1:463777495321:web:106118f53f56abd206ed88"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const CLOUDINARY_CLOUD_NAME = "dc6as14p0";
        const CLOUDINARY_UPLOAD_PRESET = "lumix-financas-uploads";
        const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
        const DEFAULT_LOGO_URL = "https://res.cloudinary.com/dc6as14p0/image/upload/v1759611967/LOGO---LUMIX-FINANZAS-REDUCIDO_gc8zow.png";
        
        let currentClient = null;
        let unsubscribeClient = null;
        let currentLang = localStorage.getItem('language') || 'pt';
        let deferredPrompt; // For PWA installation
        const nationalHolidays = [ '01/01', '21/04', '01/05', '07/09', '12/10', '02/11', '15/11', '25/12' ];
        let receiptFile = null;
        let notificationInterval;
        let selectedLoanIndex = 0;
        let collectorSettings = null; // Para almacenar la configuración del cobrador

        const PAYMENT_CONFIGS = {
            // Suramérica
            "BRL": { name: "Real Brasileiro", methods: [ { id: 'brl_pix', label: 'Chave PIX', type: 'text', placeholder: 'CPF, e-mail, telefone...' }, { id: 'brl_qrcode_text', label: 'PIX Copia e Cola', type: 'textarea', placeholder: 'Cole o código BR...' }, { id: 'brl_qrcode_image', label: 'Imagem QR Code PIX', type: 'image' } ]},
            "ARS": { name: "Peso Argentino", methods: [ { id: 'ars_mercadopago', label: 'Mercado Pago (CVU/Alias)', type: 'text', placeholder: 'CVU ou Alias da conta' }, { id: 'ars_transferencia', label: 'Transferencia Bancaria (CBU)', type: 'text', placeholder: 'CBU da conta bancária' } ]},
            "BOB": { name: "Boliviano", methods: [ { id: 'bob_qr', label: 'QR Simple', type: 'image' }, { id: 'bob_tigomoney', label: 'Tigo Money', type: 'tel', placeholder: 'Número de Teléfono' } ]},
            "CLP": { name: "Peso Chileno", methods: [ { id: 'clp_transferencia', label: 'Transferencia (Cuenta RUT)', type: 'text', placeholder: 'RUT o datos de la cuenta' } ]},
            "COP": { name: "Peso Colombiano", methods: [ { id: 'cop_nequi', label: 'Nequi', type: 'tel', placeholder: 'Número de telefone Nequi' }, { id: 'cop_daviplata', label: 'Daviplata', type: 'tel', placeholder: 'Número de telefone Daviplata' }, { id: 'cop_bancolombia', label: 'Bancolombia A la Mano', type: 'text', placeholder: 'Número de cuenta o teléfono' }, { id: 'cop_qrcode_image', label: 'Imagem QR Code Genérico', type: 'image' } ]},
            "USD_EC": { name: "Dólar (Ecuador)", methods: [ { id: 'ec_transferencia_pichincha', label: 'Transferencia Banco Pichincha', type: 'text', placeholder: 'Datos de la cuenta' }, { id: 'ec_transferencia_guayaquil', label: 'Transferencia Banco Guayaquil', type: 'text', placeholder: 'Datos de la cuenta' } ]},
            "PYG": { name: "Guaraní Paraguayo", methods: [ { id: 'pyg_giros', label: 'Giros Tigo / Personal', type: 'tel', placeholder: 'Número de Teléfono' }, { id: 'pyg_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta' } ]},
            "PEN": { name: "Sol Peruano", methods: [ { id: 'pen_yape', label: 'Yape', type: 'tel', placeholder: 'Número de Celular o QR' }, { id: 'pen_plin', label: 'Plin', type: 'tel', placeholder: 'Número de Celular' } ]},
            "UYU": { name: "Peso Uruguayo", methods: [ { id: 'uyu_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta' } ]},
            "VES": { name: "Bolívar Venezuelano", methods: [ { id: 'ves_pagomovil', label: 'Pago Móvil', type: 'text', placeholder: 'C.I, Banco, Teléfono' } ]},
            // Centroamérica
            "CRC": { name: "Colón Costarricense", methods: [ { id: 'crc_sinpe', label: 'SINPE Móvil', type: 'tel', placeholder: 'Número de Teléfono' } ]},
            "GTQ": { name: "Quetzal Guatemalteco", methods: [ { id: 'gtq_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta (BAC, BI, etc.)' } ]},
            "HNL": { name: "Lempira Hondureña", methods: [ { id: 'hnl_tigomoney', label: 'Tigo Money', type: 'tel', placeholder: 'Número de Teléfono' }, { id: 'hnl_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta' } ]},
            "NIO": { name: "Córdoba Nicaragüense", methods: [ { id: 'nio_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta (Lafise, BAC)' } ]},
            "PAB": { name: "Balboa Panameño / USD", methods: [ { id: 'pab_yappy', label: 'Yappy (Banco General)', type: 'tel', placeholder: 'Número de Teléfono' }, { id: 'pab_nequi', label: 'Nequi Panamá', type: 'tel', placeholder: 'Número de Teléfono' } ]},
            "USD_SV": { name: "Dólar (El Salvador)", methods: [ { id: 'sv_chivo', label: 'Chivo Wallet', type: 'text', placeholder: 'Número de DUI o Teléfono' }, { id: 'sv_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta' } ]},
            // Norteamérica y General
            "USD": { name: "Dólar Americano (General)", methods: [ { id: 'usd_zelle', label: 'Zelle', type: 'email', placeholder: 'E-mail ou telefone Zelle' }, { id: 'usd_cashapp', label: 'Cash App', type: 'text', placeholder: '$Cashtag' }, { id: 'usd_paypal', label: 'PayPal', type: 'email', placeholder: 'E-mail do PayPal.me' } ]},
            "MXN": { name: "Peso Mexicano", methods: [ { id: 'mxn_spei', label: 'Transferencia SPEI (CLABE)', type: 'text', placeholder: 'CLABE Interbancaria' }, { id: 'mxn_oxxo', label: 'Pago en OXXO', type: 'text', placeholder: 'Número de referência para OXXO Pay' } ]},
            "CAD": { name: "Dólar Canadiense", methods: [ { id: 'cad_interac', label: 'Interac e-Transfer', type: 'email', placeholder: 'Email para transferencia' } ]}
        };

        const CURRENCY_FORMATS = {
            "BRL": { locale: 'pt-BR', currency: 'BRL' }, "ARS": { locale: 'es-AR', currency: 'ARS' },
            "BOB": { locale: 'es-BO', currency: 'BOB' }, "CLP": { locale: 'es-CL', currency: 'CLP' },
            "COP": { locale: 'es-CO', currency: 'COP' }, "USD_EC": { locale: 'es-EC', currency: 'USD' },
            "PYG": { locale: 'es-PY', currency: 'PYG' }, "PEN": { locale: 'es-PE', currency: 'PEN' },
            "UYU": { locale: 'es-UY', currency: 'UYU' }, "VES": { locale: 'es-VE', currency: 'VES' },
            "CRC": { locale: 'es-CR', currency: 'CRC' }, "GTQ": { locale: 'es-GT', currency: 'GTQ' },
            "HNL": { locale: 'es-HN', currency: 'HNL' }, "NIO": { locale: 'es-NI', currency: 'NIO' },
            "PAB": { locale: 'es-PA', currency: 'PAB' }, "USD_SV": { locale: 'es-SV', currency: 'USD' },
            "USD": { locale: 'en-US', currency: 'USD' }, "MXN": { locale: 'es-MX', currency: 'MXN' },
            "CAD": { locale: 'en-CA', currency: 'CAD' }
        };
        
        const PIX_KEY_FIXED = "000.0.0.000-00"; // This is now legacy, will be replaced by dynamic data.
        const PIX_KEY_MANUAL = "chave-manual@email.com"; // This is now legacy.

        // ¡¡¡ ACCIÓN REQUERIDA !!!
        // Reemplaza la siguiente clave con tu "Public VAPID key" real desde:
        // Firebase Console -> Project Settings -> Cloud Messaging -> Web configuration -> Key pair
        const FCM_VAPID_KEY = "BAgKWBzKi_Z4eyNNgGtprgPRQhPzU2MqU1vyrHf0iQSMxy1UMkin4E3GJ7KQLtChcDJHtEx8mMYau4jtzQvtjfw"; // IMPORTANTE: Substitua pela sua VAPID key do Firebase Cloud Messaging

        const translations = {
            pt: {
                welcome: 'Bem-vindo de volta',
                welcomeMsg: 'Acesse sua conta para continuar',
                username: 'Nome de usuário',
                password: 'Senha',
                loginBtn: 'Entrar',
                invalidCredentials: 'Usuário ou senha inválidos.',
                genericError: 'Ocorreu um erro. Tente novamente.',
                appTitle: 'Portal do Cliente',
                loanProgress: 'Progresso do Empréstimo',
                reputationScore: 'Pontuação de Reputação',
                reputationInfo: 'Pagar em dia melhora sua pontuação.',
                totalValue: 'Valor Total',
                remainingValue: 'Valor Restante',
                installmentValue: 'Valor da Parcela',
                paymentHistory: 'Histórico de Pagamentos',
                noPayments: 'Nenhum pagamento registrado.',
                reputationPerfect: 'Perfeito',
                reputationGood: 'Bom',
                reputationRegular: 'Regular',
                reputationBad: 'Ruim',
                payInstallment: 'Pagar Parcela',
                qrCodePayment: 'Pagar com QR Code',
                manualPayment: 'Pagar com Chave Manual',
                manualPixKey: 'Use esta chave PIX para pagamento manual:',
                copyCode: 'Copiar Código',
                copied: 'Código PIX copiado!',
                uploadReceipt: 'Enviar Comprovante',
                paymentAmountLabel: 'Valor do Pagamento',
                submitForVerification: 'Enviar para Verificação',
                receiptSent: 'Comprovante enviado para análise!',
                uploadError: 'Erro ao enviar comprovante.',
                invalidAmount: 'Por favor, insira um valor válido.',
                paymentSent: 'enviou um comprovante de pagamento no valor de',
                settings: 'Configurações',
                logout: 'Sair',
                accountNotFound: 'Conta não encontrada. Faça login novamente.',
                dataLoadError: 'Erro ao carregar dados.',
                cropImage: 'Recortar Imagem',
                cancel: 'Cancelar',
                confirmCrop: 'Confirmar',
                picUpdateSuccess: 'Foto de perfil atualizada!',
                picUpdateError: 'Erro ao atualizar foto.',
                navDashboard: 'Painel',
                navPay: 'Pagar',
                navRefinance: 'Refinanciar',
                navNotifications: 'Notificações',
                notificationsTitle: 'Notificações',
                clearNotifications: 'Limpar tudo',
                notificationsCleared: 'Notificações limpas.',
                notificationRead: 'Notificação marcada como lida.',
                noNotifications: 'Nenhuma notificação nova.',
                awaitingVerification: 'Aguardando verificação',
                approved: 'Aprovado',
                installAppTitle: 'Instale nosso aplicativo',
                installAppMsg: 'Uma experiência mais rápida e completa.',
                installBtn: 'Instalar',
                refinanceTitle: 'Refinanciamento',
                requestNewFinancing: 'Solicitar Novo Financiamento',
                newAmount: 'Novo Valor Desejado',
                newInstallments: 'Número de Parcelas',
                sendForAnalysis: 'Enviar para Análise',
                analysisSent: 'Solicitação enviada para análise!',
                refinanceRequested: 'solicitou um refinanciamento de',
                reputationNotGoodTitle: 'Melhore sua Pontuação',
                reputationNotGoodMsg: 'Para solicitar um refinanciamento, sua pontuação de reputação precisa ser "Perfeita". Continue pagando suas parcelas em dia!',
                latePaymentReminderTitle: 'Lembrete de Pagamento',
                latePaymentReminderBody: 'Notamos um atraso em seu pagamento. Para evitar encargos, por favor, regularize sua situação.',
                urgentWarningTitle: 'AVISO URGENTE: Pagamentos Atrasados',
                urgentWarningBody: 'Você possui {count} parcelas em atraso. É crucial que você regularize sua dívida.',
                paymentInstallmentTitle: 'Pagamento Parcela #{installment}',
                paymentInstallmentsTitle: 'Pagamento Parcelas #{start} - #{end}',
                partialPaymentDesc: 'Pagamento parcial ({percent}%) da parcela.',
                fullPaymentDesc: 'Parcela #{installment} paga integralmente.',
                multiplePaymentDesc: 'Cobre {count} parcela(s) e {percent}% da próxima.',
                multipleFullPaymentDesc: 'Cobre {count} parcela(s) integralmente.',
                loanFinished: 'Seu empréstimo já foi totalmente pago!',
                loanLabel: 'Empréstimo',
                paymentOptions: 'Opções de Pagamento',
                copyKey: 'Copiar Chave',
                noPaymentMethodsConfigured: 'Nenhum método de pagamento configurado pelo seu cobrador.'
            },
            es: {
                welcome: 'Bienvenido de vuelta',
                welcomeMsg: 'Accede a tu cuenta para continuar',
                username: 'Nombre de usuario',
                password: 'Contraseña',
                loginBtn: 'Entrar',
                invalidCredentials: 'Usuario o contraseña inválidos.',
                genericError: 'Ocurrió un error. Inténtalo de nuevo.',
                appTitle: 'Portal del Cliente',
                loanProgress: 'Progreso del Préstamo',
                reputationScore: 'Puntuación de Reputación',
                reputationInfo: 'Pagar a tiempo mejora tu puntuación.',
                totalValue: 'Valor Total',
                remainingValue: 'Valor Restante',
                installmentValue: 'Valor de la Cuota',
                paymentHistory: 'Historial de Pagos',
                noPayments: 'No hay pagos registrados.',
                reputationPerfect: 'Perfecto',
                reputationGood: 'Bueno',
                reputationRegular: 'Regular',
                reputationBad: 'Malo',
                payInstallment: 'Pagar Cuota',
                qrCodePayment: 'Pagar con Código QR',
                manualPayment: 'Pagar con Clave Manual',
                manualPixKey: 'Usa esta clave PIX para pago manual:',
                copyCode: 'Copiar Código',
                copied: '¡Código PIX copiado!',
                uploadReceipt: 'Enviar Comprobante',
                paymentAmountLabel: 'Valor del Pago',
                submitForVerification: 'Enviar para Verificación',
                receiptSent: '¡Comprobante enviado para análisis!',
                uploadError: 'Error al enviar el comprobante.',
                invalidAmount: 'Por favor, ingrese un valor válido.',
                paymentSent: 'envió un comprobante de pago por valor de',
                settings: 'Configuración',
                logout: 'Salir',
                accountNotFound: 'Cuenta no encontrada. Inicia sesión de nuevo.',
                dataLoadError: 'Error al cargar los datos.',
                cropImage: 'Recortar Imagen',
                cancel: 'Cancelar',
                confirmCrop: 'Confirmar',
                picUpdateSuccess: '¡Foto de perfil actualizada!',
                picUpdateError: 'Error al actualizar la foto.',
                navDashboard: 'Panel',
                navPay: 'Pagar',
                navRefinance: 'Refinanciar',
                navNotifications: 'Notificaciones',
                notificationsTitle: 'Notificaciones',
                clearNotifications: 'Limpiar todo',
                notificationsCleared: 'Notificaciones limpiadas.',
                notificationRead: 'Notificación marcada como leída.',
                noNotifications: 'No hay notificaciones nuevas.',
                awaitingVerification: 'Esperando verificación',
                approved: 'Aprobado',
                installAppTitle: 'Instala nuestra aplicación',
                installAppMsg: 'Una experiencia más rápida y completa.',
                installBtn: 'Instalar',
                refinanceTitle: 'Refinanciación',
                requestNewFinancing: 'Solicitar Nueva Financiación',
                newAmount: 'Nuevo Valor Deseado',
                newInstallments: 'Número de Cuotas',
                sendForAnalysis: 'Enviar para Análisis',
                analysisSent: '¡Solicitud enviada para análisis!',
                refinanceRequested: 'solicitó una refinanciación de',
                reputationNotGoodTitle: 'Mejora tu Puntuación',
                reputationNotGoodMsg: 'Para solicitar una refinanciación, tu puntuación de reputación debe ser "Perfecta". ¡Sigue pagando tus cuotas a tiempo!',
                latePaymentReminderTitle: 'Recordatorio de Pago',
                latePaymentReminderBody: 'Hemos notado un retraso en su pago. Para evitar cargos, por favor, regularice su situación.',
                urgentWarningTitle: 'AVISO URGENTE: Pagos Atrasados',
                urgentWarningBody: 'Usted tiene {count} cuotas atrasadas. Es crucial que regularice su deuda.',
                paymentInstallmentTitle: 'Pago Cuota #{installment}',
                paymentInstallmentsTitle: 'Pago Cuotas #{start} - #{end}',
                partialPaymentDesc: 'Pago parcial ({percent}%) de la cuota.',
                fullPaymentDesc: 'Cuota #{installment} pagada completamente.',
                multiplePaymentDesc: 'Cubre {count} cuota(s) y un {percent}% de la siguiente.',
                multipleFullPaymentDesc: 'Cubre {count} cuota(s) completamente.',
                loanFinished: '¡Tu préstamo ya ha sido pagado en su totalidad!',
                loanLabel: 'Préstamo',
                paymentOptions: 'Opciones de Pago',
                copyKey: 'Copiar Clave',
                noPaymentMethodsConfigured: 'Ningún método de pago configurado por tu cobrador.'
            },
            en: {
                welcome: 'Welcome back',
                welcomeMsg: 'Log in to your account to continue',
                username: 'Username',
                password: 'Password',
                loginBtn: 'Login',
                invalidCredentials: 'Invalid username or password.',
                genericError: 'An error occurred. Please try again.',
                appTitle: 'Client Portal',
                loanProgress: 'Loan Progress',
                reputationScore: 'Reputation Score',
                reputationInfo: 'Paying on time improves your score.',
                totalValue: 'Total Value',
                remainingValue: 'Remaining Value',
                installmentValue: 'Installment Value',
                paymentHistory: 'Payment History',
                noPayments: 'No payments registered.',
                reputationPerfect: 'Perfect',
                reputationGood: 'Good',
                reputationRegular: 'Regular',
                reputationBad: 'Bad',
                payInstallment: 'Pay Installment',
                qrCodePayment: 'Pay with QR Code',
                manualPayment: 'Pay with Manual Key',
                manualPixKey: 'Use this PIX key for manual payment:',
                copyCode: 'Copy Code',
                copied: 'PIX Code copied!',
                uploadReceipt: 'Upload Receipt',
                paymentAmountLabel: 'Payment Amount',
                submitForVerification: 'Submit for Verification',
                receiptSent: 'Receipt sent for analysis!',
                uploadError: 'Error uploading receipt.',
                invalidAmount: 'Please enter a valid amount.',
                paymentSent: 'sent a payment receipt for the amount of',
                settings: 'Settings',
                logout: 'Logout',
                accountNotFound: 'Account not found. Please log in again.',
                dataLoadError: 'Error loading data.',
                cropImage: 'Crop Image',
                cancel: 'Cancel',
                confirmCrop: 'Confirm',
                picUpdateSuccess: 'Profile picture updated!',
                picUpdateError: 'Error updating picture.',
                navDashboard: 'Dashboard',
                navPay: 'Pay',
                navRefinance: 'Refinance',
                navNotifications: 'Notifications',
                notificationsTitle: 'Notifications',
                clearNotifications: 'Clear all',
                notificationsCleared: 'Notifications cleared.',
                notificationRead: 'Notification marked as read.',
                noNotifications: 'No new notifications.',
                awaitingVerification: 'Awaiting verification',
                approved: 'Approved',
                installAppTitle: 'Install our app',
                installAppMsg: 'A faster and more complete experience.',
                installBtn: 'Install',
                refinanceTitle: 'Refinancing',
                requestNewFinancing: 'Request New Financing',
                newAmount: 'New Desired Amount',
                newInstallments: 'Number of Installments',
                sendForAnalysis: 'Send for Analysis',
                analysisSent: 'Request sent for analysis!',

                refinanceRequested: 'requested a refinancing of',
                reputationNotGoodTitle: 'Improve Your Score',
                reputationNotGoodMsg: 'To request refinancing, your reputation score needs to be "Perfect". Keep paying your installments on time!',
                latePaymentReminderTitle: 'Payment Reminder',
                latePaymentReminderBody: 'We noticed a delay in your payment. To avoid charges, please regularize your situation.',
                urgentWarningTitle: 'URGENT NOTICE: Overdue Payments',
                urgentWarningBody: 'You have {count} overdue installments. It is crucial that you regularize your debt.',
                paymentInstallmentTitle: 'Payment Installment #{installment}',
                paymentInstallmentsTitle: 'Payment Installments #{start} - #{end}',
                partialPaymentDesc: 'Partial payment ({percent}%) of the installment.',
                fullPaymentDesc: 'Installment #{installment} paid in full.',
                multiplePaymentDesc: 'Covers {count} installment(s) and {percent}% of the next one.',
                multipleFullPaymentDesc: 'Covers {count} installment(s) completely.',
                loanFinished: 'Your loan is already fully paid!',
                loanLabel: 'Loan',
                paymentOptions: 'Opciones de Pago',
                copyKey: 'Copiar Clave',
                noPaymentMethodsConfigured: 'No payment methods have been configured by your collector.'
            }
        };

        function showToast(message, isError = false) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = 'toast';
            if (isError) {
                toast.classList.add('toast-error');
            }
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function money(value) {
            const currencyCode = collectorSettings?.paymentSettings?.currency || 'BRL';
            const format = CURRENCY_FORMATS[currencyCode] || CURRENCY_FORMATS['BRL'];
            return (value || 0).toLocaleString(format.locale, { style: 'currency', currency: format.currency });
        }

        async function sendNotificationTicket(title, body, type, icon) {
            const LOG_PREFIX = `[CLIENTE-APP]`;
            if (!currentClient) return;
            console.log(`${LOG_PREFIX} -> sendNotificationTicket: Iniciando creación de notificación y ticket PUSH.`);
            try {
                const clientRef = doc(db, 'clients', currentClient.id);
                // 1. Añade a la lista interna de notificaciones de la app
                const internalNotif = {
                    title: title, body: body, icon: icon, read: false, timestamp: new Date(), id: `${type}_${Date.now()}`
                };
                await updateDoc(clientRef, {
                    notifications: arrayUnion(internalNotif),
                    lastLateNotificationTimestamp: serverTimestamp() // Reutilizamos este campo para evitar spam
                });
                console.log(`${LOG_PREFIX} -> sendNotificationTicket: Notificación INTERNA guardada en el historial del cliente.`);

                // 2. Crea el ticket para la notificación PUSH
                const ticketsCollectionRef = collection(db, 'clients', currentClient.id, 'pushNotificationTickets');
                await addDoc(ticketsCollectionRef, {
                    title: title, body: body, type: type
                });

                console.log(`${LOG_PREFIX} -> sendNotificationTicket: ¡ÉXITO! Ticket PUSH creado en Firestore.`);
            } catch (error) {
                console.error(`${LOG_PREFIX} -> sendNotificationTicket: ERROR FATAL al crear notificación/ticket.`, error);
            }
        }

        async function checkAndSendLatePaymentNotifications() {
            const LOG_PREFIX = `[CLIENTE-APP]`;
            if (!currentClient || !currentClient.loans || currentClient.loans.length === 0) return;

            const currentLoan = currentClient.loans[selectedLoanIndex];
            if (!currentLoan) return;

            console.log(`${LOG_PREFIX} -> checkAndSendLatePaymentNotifications: Iniciando verificación de pagos atrasados...`);

            const lateInstallments = calculateLatePaymentDays(currentLoan);
            console.log(`${LOG_PREFIX} -> checkAndSendLatePaymentNotifications: Días de atraso calculados: ${lateInstallments}`);
            
            if (lateInstallments <= 0) {
                console.log(`${LOG_PREFIX} -> checkAndSendLatePaymentNotifications: No hay atrasos. Verificación finalizada.`);
                return;
            }

            const now = new Date();
            const twelveHoursAgo = new Date(now.getTime() - (12 * 60 * 60 * 1000));
            const lastNotificationTimestamp = currentClient.lastLateNotificationTimestamp?.toDate();

            if (lastNotificationTimestamp && lastNotificationTimestamp > twelveHoursAgo) {
                console.log(`${LOG_PREFIX} -> checkAndSendLatePaymentNotifications: Notificación de atraso suprimida, enviada recientemente (hace menos de 12h).`);
                return;
            }
            console.log(`${LOG_PREFIX} -> checkAndSendLatePaymentNotifications: Es necesario enviar notificación. Preparando datos...`);

            let title, body, type, icon;
            if (lateInstallments === 1) {
                title = translations[currentLang].latePaymentReminderTitle;
                body = translations[currentLang].latePaymentReminderBody;
                type = 'late_reminder';
                icon = 'alarm-clock';
            } else { 
                title = translations[currentLang].urgentWarningTitle;
                body = translations[currentLang].urgentWarningBody.replace('{count}', lateInstallments);
                type = 'urgent_warning';
                icon = 'alert-triangle';
            }

            await sendNotificationTicket(title, body, type, icon);
        }

        function applyLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            document.documentElement.lang = lang.startsWith('es') ? 'es' : (lang.startsWith('en') ? 'en' : 'pt-BR');
        }

        function applyTheme(theme) {
            const body = document.body;
            body.classList.toggle('dark-mode', theme === 'dark');
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.innerHTML = `<i data-lucide="${theme === 'dark' ? 'sun' : 'moon'}"></i>`;
                lucide.createIcons({ nodes: [themeToggle] });
            }
        }
        
        function calculateLatePaymentDays(loan) {
            if (!loan || (loan.paid || 0) >= (loan.totalLoan || 0)) return 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let lastRelevantDate;
            if (loan.history && loan.history.length > 0) {
                const sortedHistory = [...loan.history]
                    .filter(h => h.date?.seconds && h.status !== 'pending_verification')
                    .sort((a, b) => b.date.seconds - a.date.seconds);
                if (sortedHistory.length > 0) lastRelevantDate = new Date(sortedHistory[0].date.seconds * 1000);
            } 
            if (!lastRelevantDate) {
                if (loan.startDate?.seconds) {
                    lastRelevantDate = new Date(loan.startDate.seconds * 1000);
                } else {
                     return 0;
                }
            }
            
            let lateDays = 0;
            let checkDate = new Date(lastRelevantDate);
            checkDate.setDate(checkDate.getDate() + 1); // Empezamos a contar desde el día siguiente al último pago/inicio

            while (checkDate <= today) {
                const dayOfWeek = checkDate.getDay();
                const dateString = ('0' + checkDate.getDate()).slice(-2) + '/' + ('0' + (checkDate.getMonth() + 1)).slice(-2);
                
                if (dayOfWeek !== 0 && !nationalHolidays.includes(dateString)) {
                    lateDays++;
                }
                checkDate.setDate(checkDate.getDate() + 1);
            }
            return lateDays;
        }

        function renderLoanTabs() {
            const tabsContainer = document.getElementById('loan-tabs-container');
            if (!tabsContainer || !currentClient) return;

            // [CORRECCIÓN] Mapear primero para conservar el índice original antes de filtrar.
            const loansWithOriginalIndex = (currentClient.loans || []).map((loan, index) => ({ ...loan, originalIndex: index }));
            const activeLoans = loansWithOriginalIndex.filter(l => l.status === 'active');
            
            if (activeLoans.length > 1) {
                tabsContainer.style.display = 'flex';
                // [CORRECCIÓN] Usar el 'originalIndex' guardado en el dataset y para la comparación.
                tabsContainer.innerHTML = activeLoans.map((loan) => `
                    <button class="loan-tab ${loan.originalIndex === selectedLoanIndex ? 'active' : ''}" data-index="${loan.originalIndex}">
                        ${translations[currentLang].loanLabel} ${loan.originalIndex + 1}
                    </button>
                `).join('');
            } else {
                tabsContainer.style.display = 'none';
            }
        }

        function updateReputationView() {
             if (!currentClient || !document.getElementById('reputation-card')) return;
            
            const currentLoan = (currentClient.loans || [])[selectedLoanIndex];
            if (!currentLoan) return;

            const lateDays = calculateLatePaymentDays(currentLoan);
            const score = Math.max(0, 10 - lateDays); 

            const bar = document.getElementById('reputation-bar');
            const valueEl = document.getElementById('reputation-value');
            const textEl = document.getElementById('reputation-text');

            bar.style.width = `${score * 10}%`;
            valueEl.textContent = `${score} / 10`;

            bar.className = 'reputation-bar'; // Reset classes
            textEl.className = 'reputation-text';

            if (score === 10) {
                bar.classList.add('status-perfect');
                textEl.classList.add('status-perfect');
                textEl.textContent = translations[currentLang].reputationPerfect;
            } else if (score >= 7) {
                bar.classList.add('status-good');
                textEl.classList.add('status-good');
                textEl.textContent = translations[currentLang].reputationGood;
            } else if (score >= 3) {
                bar.classList.add('status-regular');
                textEl.classList.add('status-regular');
                textEl.textContent = translations[currentLang].reputationRegular;
            } else {
                bar.classList.add('status-bad');
                textEl.classList.add('status-bad');
                textEl.textContent = translations[currentLang].reputationBad;
            }
        }

        function showView(viewName) {
            const views = document.querySelectorAll('.view');
            views.forEach(view => view.classList.remove('active'));
            const activeView = document.getElementById(`${viewName}-view`);
            if (activeView) activeView.classList.add('active');

            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            const activeNavItem = document.querySelector(`.nav-item[data-view="${viewName}"]`);
            if (activeNavItem) activeNavItem.classList.add('active');

            // Carga datos específicos de la vista si es necesario
            if (viewName === 'refinance' && currentClient) {
                updateRefinanceView();
            }
        }

        function updateDashboardView() {
            if (!currentClient || !document.getElementById('home-view') || !currentClient.loans || currentClient.loans.length === 0) return;
            
            const currentLoan = currentClient.loans[selectedLoanIndex];
            if (!currentLoan) return;

            const paidAmount = currentLoan.paid || 0;
            const totalAmount = currentLoan.totalLoan || 0;
            const remainingAmount = Math.max(0, totalAmount - paidAmount);
            
            const originalInstallment = currentLoan.originalInstallmentAmount || 1; // Evitar división por cero
            const totalInstallments = currentLoan.totalInstallments || 0;
            const paidInstallments = totalInstallments > 0 ? Math.min(totalInstallments, Math.floor(paidAmount / originalInstallment)) : 0;
            const progressPercentage = totalInstallments > 0 ? (paidInstallments / totalInstallments) * 100 : 0;
            
            const circleCircumference = 2 * Math.PI * 54;
            const strokeDashoffset = circleCircumference - (progressPercentage / 100) * circleCircumference;

            let historyHtml = `<p class="no-history" data-lang-key="noPayments">${translations[currentLang].noPayments}</p>`;
            if (currentLoan.history && currentLoan.history.length > 0) {
                let cumulativePaid = 0;

                const paymentDetails = [...currentLoan.history]
                    .filter(p => p.date && p.date.seconds) 
                    .sort((a, b) => a.date.seconds - b.date.seconds) 
                    .map(p => {
                        const installmentNumberStart = Math.floor(cumulativePaid / originalInstallment) + 1;
                        
                        const numInstallmentsCovered = p.amount / originalInstallment;
                        const fullInstallments = Math.floor(numInstallmentsCovered);
                        const partialPercent = Math.round((numInstallmentsCovered - fullInstallments) * 100);

                        let title = translations[currentLang].paymentInstallmentTitle.replace('{installment}', installmentNumberStart);
                        let description = '';

                        if (numInstallmentsCovered < 0.99) { // Usar 0.99 para evitar errores de punto flotante
                            description = translations[currentLang].partialPaymentDesc.replace('{percent}', (numInstallmentsCovered * 100).toFixed(0));
                        } else if (numInstallmentsCovered >= 0.99 && numInstallmentsCovered < 1.01) {
                            description = translations[currentLang].fullPaymentDesc.replace('{installment}', installmentNumberStart);
                        } else {
                            const endInstallment = installmentNumberStart + fullInstallments - 1;
                            title = translations[currentLang].paymentInstallmentsTitle
                                .replace('{start}', installmentNumberStart)
                                .replace('{end}', endInstallment > installmentNumberStart ? endInstallment : '');
                            
                             if (partialPercent > 1) { // Usar > 1 para ignorar pequeños residuos
                                description = translations[currentLang].multiplePaymentDesc
                                    .replace('{count}', fullInstallments)
                                    .replace('{percent}', partialPercent);
                            } else {
                                description = translations[currentLang].multipleFullPaymentDesc.replace('{count}', fullInstallments);
                            }
                        }

                        cumulativePaid += p.amount;

                        return {
                            ...p,
                            dateTimeString: new Date(p.date.seconds * 1000).toLocaleString(currentLang, { dateStyle: 'short', timeStyle: 'short'}),
                            title: title,
                            description: description,
                        };
                    });
                
                historyHtml = paymentDetails.reverse() 
                    .map(p => {
                         let statusTag = '';
                        if (p.status === 'pending_verification') {
                            statusTag = `<span class="payment-status-tag pending">${translations[currentLang].awaitingVerification}</span>`;
                        } else if (p.status === 'approved' || !p.status) {
                            statusTag = `<span class="payment-status-tag approved">${translations[currentLang].approved}</span>`;
                        }
                        
                        return `<div class="payment-history-item">
                                    <div class="payment-info">
                                        <h4 class="payment-title">${p.title}</h4>
                                        <p class="payment-description">${p.description}</p>
                                        <span class="payment-date">${p.dateTimeString}</span>
                                    </div>
                                    <div class="payment-status-wrapper">
                                        <span class="payment-amount" style="color: ${p.status !== 'pending_verification' ? 'var(--accent-green)' : 'var(--text-secondary)'}">${money(p.amount)}</span>
                                        ${statusTag}
                                    </div>
                                </div>`;
                    }).join('');
            }
            
            document.getElementById('progress-text').textContent = `${paidInstallments}/${totalInstallments}`;
            document.getElementById('progress-bar').style.strokeDashoffset = strokeDashoffset;
            document.getElementById('total-value').textContent = money(totalAmount);
            document.getElementById('remaining-value').textContent = money(remainingAmount);
            document.getElementById('kpi-installment-value').textContent = money(currentLoan.originalInstallmentAmount || 0);
            
            document.getElementById('payment-history-list').innerHTML = historyHtml;
            
            updateReputationView();

            // Desactiva la pestaña de Pagar si el préstamo está completo
            const payNavItem = document.querySelector('.nav-item[data-view="pay"]');
            if (payNavItem) {
                if (paidInstallments >= totalInstallments && totalInstallments > 0) {
                    payNavItem.classList.add('disabled');
                } else {
                    payNavItem.classList.remove('disabled');
                }
            }
            lucide.createIcons({nodes: document.getElementById('home-view').querySelectorAll('[data-lucide]')});
        }

        function updateProfileView() {
            if (!currentClient) return;
            const profileView = document.getElementById('profile-view');

            const nameInitial = (currentClient.name || 'C').charAt(0).toUpperCase();
            const placeholderUrl = `https://placehold.co/120x120/6f42c1/FFFFFF?text=${nameInitial}`;
            const photoUrl = currentClient.profilePictureUrl || placeholderUrl;

            profileView.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 30px;">
                    <label for="profile-pic-input" class="profile-pic-wrapper">
                        <img id="profile-view-img" src="${photoUrl}" alt="Foto do Cliente">
                    </label>
                    <input type="file" id="profile-pic-input" accept="image/*" style="display: none;">
                    <h2 style="margin: 15px 0 0; font-size: 1.5em;">${currentClient.name}</h2>
                    <p style="margin: 5px 0 0; color: var(--text-secondary);">${currentClient.username}</p>
                </div>
                
                <section>
                    <h2 class="section-title" data-lang-key="accountSettings"></h2>
                    <div class="settings-list">
                        <a class="settings-item logout" id="logout-btn">
                            <i data-lucide="log-out"></i><span data-lang-key="logout"></span>
                        </a>
                    </div>
                </section>
            `;

            lucide.createIcons({ nodes: profileView.querySelectorAll('[data-lucide]') });
            applyLanguage(currentLang);

            profileView.querySelector('#logout-btn').addEventListener('click', handleLogout);
        }

        function handleLogout() {
            if (unsubscribeClient) {
                unsubscribeClient();
            }
            if (notificationInterval) clearInterval(notificationInterval);
            sessionStorage.removeItem('lumixClientId');
            currentClient = null;
            collectorSettings = null; // Limpiar configuración del cobrador al salir
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-view').style.display = 'flex';
            // history.replaceState(null, '', window.location.pathname); // [CORRECCIÓN] Se elimina esta línea para evitar el SecurityError en el entorno de vista previa.
        }

        function updatePayView() {
            const payViewContainer = document.getElementById('pay-view');
            if (!payViewContainer) return;

            if (!collectorSettings || !collectorSettings.paymentSettings) {
                payViewContainer.innerHTML = `<h2 class="section-title" data-lang-key="paymentOptions"></h2><p class="no-history" data-lang-key="noPaymentMethodsConfigured"></p>`;
                applyLanguage(currentLang);
                return;
            }

            const settings = collectorSettings.paymentSettings;
            const activeMethods = Object.keys(settings.methods || {}).filter(id => settings.methods[id].active && settings.methods[id].data);

            let methodsHtml = `<h2 class="section-title" data-lang-key="paymentOptions"></h2>`;

            if (activeMethods.length === 0) {
                methodsHtml += `<p class="no-history" data-lang-key="noPaymentMethodsConfigured"></p>`;
            } else {
                methodsHtml += activeMethods.map(id => {
                    const methodConfig = PAYMENT_CONFIGS[settings.currency]?.methods.find(m => m.id === id);
                    const methodData = settings.methods[id].data;
                    
                    if (!methodConfig) return '';

                    if (methodConfig.type === 'image') {
                        return `<div class="kpi-card" style="margin-bottom: 20px;">
                                    <h3 class="kpi-title">${methodConfig.label}</h3>
                                    <img src="${methodData}" alt="${methodConfig.label}" style="max-width: 200px; margin: 10px auto; display: block; border-radius: 8px;">
                                </div>`;
                    } else if (methodConfig.type === 'textarea') {
                         return `<div class="kpi-card" style="margin-bottom: 20px;">
                                     <h3 class="kpi-title">${methodConfig.label}</h3>
                                     <textarea class="form-control" rows="4" readonly style="background-color: var(--border-color);">${methodData}</textarea>
                                     <button class="btn-primary copy-btn" data-copy="${methodData}" style="width:100%; margin-top:10px;"><i data-lucide="copy"></i> <span data-lang-key="copyCode"></span></button>
                                </div>`;
                    } else { // text, tel, email
                        return `<div class="kpi-card" style="margin-bottom: 20px;">
                                     <h3 class="kpi-title">${methodConfig.label}</h3>
                                     <div style="display:flex; gap:10px; align-items:center;">
                                         <strong style="background-color: var(--border-color); padding: 10px; border-radius: 8px; flex-grow:1; text-align: center; overflow-wrap: break-word;">${methodData}</strong>
                                         <button class="btn-primary copy-btn" data-copy="${methodData}" style="flex-shrink:0;"><i data-lucide="copy"></i></button>
                                     </div>
                                </div>`;
                    }
                }).join('');
            }
            
            methodsHtml += `
                 <div class="kpi-card" style="margin-top: 30px;">
                    <h3 class="section-title" data-lang-key="uploadReceipt"></h3>
                    <div class="form-group">
                        <label for="receipt-amount" data-lang-key="paymentAmountLabel"></label>
                        <input type="number" id="receipt-amount" step="0.01" placeholder="0.00" class="form-control">
                    </div>
                     <label for="receipt-file-input" class="upload-receipt-btn">
                         <i data-lucide="upload-cloud"></i>
                         <span id="upload-label-text">Clique para anexar</span>
                         <img id="receipt-preview" style="display:none;">
                     </label>
                     <input type="file" id="receipt-file-input" accept="image/*" style="display:none;">
                     <button class="btn-primary" id="submit-receipt-btn" style="width:100%; margin-top:15px;" disabled><i data-lucide="send"></i> <span data-lang-key="submitForVerification"></span></button>
                 </div>`;
            
            payViewContainer.innerHTML = methodsHtml;
            applyLanguage(currentLang);
            lucide.createIcons({nodes: payViewContainer.querySelectorAll('[data-lucide]')});
        }

        function updateRefinanceView() {
            if (!currentClient || !document.getElementById('refinance-view')) return;
            const container = document.getElementById('refinance-view');
            const currentLoan = currentClient.loans[selectedLoanIndex];
            if (!currentLoan) return;

            const lateDays = calculateLatePaymentDays(currentLoan);
            const score = Math.max(0, 10 - lateDays);
            let content = '';

            if (currentClient.refinanceRequest) {
                content = `<div class="container kpi-card"><h2 class="section-title" data-lang-key="refinanceTitle"></h2><p>${translations[currentLang].analysisSent}</p></div>`;
            } else if (score === 10) {
                content = `<div class="container"><h2 class="section-title" data-lang-key="refinanceTitle"></h2><div class="kpi-card"><form id="refinance-form"><div class="form-group"><label for="refinance-amount" data-lang-key="newAmount"></label><input type="number" id="refinance-amount" class="form-control" required></div><div class="form-group"><label for="refinance-installments" data-lang-key="newInstallments"></label><input type="number" id="refinance-installments" class="form-control" required></div><button type="submit" class="btn-primary" style="width:100%;"><span data-lang-key="sendForAnalysis"></span></button></form></div></div>`;
            } else {
                content = `<div class="container kpi-card"><h2 class="section-title" data-lang-key="reputationNotGoodTitle"></h2><p>${translations[currentLang].reputationNotGoodMsg}</p></div>`;
            }
            container.innerHTML = content;
            applyLanguage(currentLang);
            
            const form = document.getElementById('refinance-form');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const amount = parseFloat(document.getElementById('refinance-amount').value);
                    const installments = parseInt(document.getElementById('refinance-installments').value, 10);
                    if (isNaN(amount) || amount <= 0 || isNaN(installments) || installments <= 0) {
                        showToast(translations[currentLang].invalidAmount, true);
                        return;
                    }
                    try {
                        const clientRef = doc(db, 'clients', currentClient.id);
                        await updateDoc(clientRef, { refinanceRequest: { amount: amount, installments: installments, requestDate: new Date() } });
                        showToast(translations[currentLang].analysisSent);
                        sendNotificationToCollector(`${currentClient.name}`, `${translations[currentLang].refinanceRequested} ${money(amount)}.`, 'refinance');
                        updateRefinanceView();
                    } catch (error) {
                        console.error("Error sending refinance request:", error);
                        showToast(translations[currentLang].genericError, true);
                    }
                });
            }
        }

        function updateNotificationsView() {
            if (!currentClient || !document.getElementById('notifications-list')) return;

            const listContainer = document.getElementById('notifications-list');
            const notifications = currentClient.notifications || [];
            const unreadCount = notifications.filter(n => !n.read).length;
            
            const badge = document.querySelector('.nav-item[data-view="notifications"] .notification-badge');
            if (badge) {
                badge.style.display = unreadCount > 0 ? 'block' : 'none';
            }
            
            if (notifications.length === 0) {
                listContainer.innerHTML = `<p class="no-notifications" data-lang-key="noNotifications">${translations[currentLang].noNotifications}</p>`;
                return;
            }
            
            listContainer.innerHTML = [...notifications].reverse().map((n, index) => {
                const d = n.timestamp.toDate();
                const dateString = d.toLocaleString(currentLang, { dateStyle: 'medium', timeStyle: 'short' });
                const isUnread = n.read === false;
                const notifId = n.id || `notif_${notifications.length - 1 - index}`; 
                
                return `
                    <div class="notification-item ${isUnread ? 'unread' : ''}" data-id="${notifId}">
                        <div class="notification-icon"><i data-lucide="${n.icon || 'info'}"></i></div>
                        <div class="notification-content">
                            <h4 class="notification-title">${n.title}</h4>
                            <p class="notification-body">${n.body}</p>
                            <p class="notification-date">${dateString}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons({ nodes: listContainer.querySelectorAll('[data-lucide]') });
        }

        function updateAllViews() {
            if (!currentClient) return;

            const nameInitial = (currentClient.name || 'C').charAt(0).toUpperCase();
            const placeholderUrl = `https://placehold.co/40x40/6f42c1/FFFFFF?text=${nameInitial}`;
            document.getElementById('header-profile-img').src = currentClient.profilePictureUrl || placeholderUrl;
            
            renderLoanTabs(); // Renderiza las pestañas de préstamos primero
            updateDashboardView();
            updateProfileView();
            updatePayView();
            updateNotificationsView();

            if (document.getElementById('refinance-view').classList.contains('active')) {
                updateRefinanceView();
            }

            applyLanguage(currentLang);
            lucide.createIcons();
        }

        async function setupFCM() {
            const LOG_PREFIX = `[CLIENTE-FCM-DIAGNOSTICO]`;
            console.log(`${LOG_PREFIX} --- Iniciando setupFCM ---`);
            try {
                if (!('Notification' in window) || !('serviceWorker' in navigator)) {
                    console.error(`${LOG_PREFIX} ERROR: Notificaciones Push no son soportadas en este navegador.`);
                    return;
                }
                console.log(`${LOG_PREFIX} El navegador soporta notificaciones.`);

                const messaging = getMessaging(app);
                console.log(`${LOG_PREFIX} Objeto de Messaging obtenido.`);

                console.log(`${LOG_PREFIX} Solicitando permiso del usuario...`);
                const permission = await Notification.requestPermission();
                console.log(`${LOG_PREFIX} El permiso del usuario es: ${permission}`);
                if (permission !== 'granted') {
                    console.warn(`${LOG_PREFIX} El usuario DENEGÓ el permiso para notificaciones.`);
                    showToast('Permiso para notificaciones denegado.', true);
                    return;
                }
                console.log(`${LOG_PREFIX} Permiso CONCEDIDO.`);

                if (!FCM_VAPID_KEY) {
                    console.error(`${LOG_PREFIX} ERROR FATAL: La VAPID key no está configurada.`);
                    showToast('Configuración de notificaciones incompleta (sin VAPID key).', true);
                    return;
                }
                console.log(`${LOG_PREFIX} VAPID Key encontrada y es válida.`);

                console.log(`${LOG_PREFIX} Obteniendo token de FCM... (Este paso puede tardar)`);
                const currentToken = await getToken(messaging, { vapidKey: FCM_VAPID_KEY });

                if (currentToken) {
                    console.log(`${LOG_PREFIX} ¡TOKEN OBTENIDO CON ÉXITO!: ${currentToken.substring(0, 30)}...`);
                    if (currentClient) {
                        const existingTokens = currentClient.fcmTokens || [];
                        if (!existingTokens.includes(currentToken)) {
                            console.log(`${LOG_PREFIX} El token es nuevo. Intentando guardar en Firestore...`);
                            const clientRef = doc(db, 'clients', currentClient.id);
                            await updateDoc(clientRef, { fcmTokens: arrayUnion(currentToken) });
                            console.log(`${LOG_PREFIX} ¡ÉXITO! Token nuevo guardado en Firestore.`);
                        } else {
                            console.log(`${LOG_PREFIX} El token ya existía en Firestore. No se requiere acción.`);
                        }
                    } else {
                        console.warn(`${LOG_PREFIX} Se obtuvo un token, pero 'currentClient' no está definido. No se puede guardar.`);
                    }
                } else {
                    console.error(`${LOG_PREFIX} ERROR FATAL: No se pudo obtener el token. Causas comunes: 1) El archivo 'firebase-messaging-sw.js' no se encuentra en la raíz del sitio. 2) La VAPID key es incorrecta. 3) Problema de registro del Service Worker.`);
                    showToast('Falha ao obter token de notificação.', true);
                }

                onMessage(messaging, (payload) => {
    const LOG_PREFIX = `[CLIENTE-FCM-DIAGNOSTICO]`;
    console.log(`${LOG_PREFIX} Notificación recibida en PRIMER PLANO:`, payload);
    
    // [CORRECCIÓN] Ahora leemos el título y el cuerpo desde payload.data
    if (payload.data && payload.data.title && payload.data.body) {
        showToast(`${payload.data.title}: ${payload.data.body}`);
        
        // Simula una actualización de las notificaciones internas
        // Idealmente, aquí se debería llamar a una función que refresque la lista de notificaciones
        // Si tienes una función como `refreshInternalNotifications()`, llámala aquí.
        console.log(`${LOG_PREFIX} Actualizando la interfaz de notificaciones...`);
        
    } else {
        console.warn(`${LOG_PREFIX} El payload en primer plano no tiene el formato esperado.`, payload);
        showToast('Você recebeu uma nova notificação.');
    }
});

                console.log(`${LOG_PREFIX} --- setupFCM finalizado con éxito ---`);

            } catch (err) {
                console.error(`${LOG_PREFIX} ERROR CATASTRÓFICO en setupFCM:`, err);
                if (err.code === 'messaging/permission-blocked') {
                    showToast('As notificações estão bloqueadas. Ative-as nas configurações do seu navegador.', true);
                } else if (err.code === 'messaging/sw-registration-failed') {
                    showToast('Falha ao registrar o serviço de notificação.', true);
                } else {
                    showToast('Falha ao configurar as notificações push.', true);
                }
            }
        }

        function showMainApp(clientId) {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('splash-screen').style.display = 'none';
            
            if (!document.body.dataset.listenersAttached) {
                setupEventListeners();
                document.body.dataset.listenersAttached = 'true';
            }
            
            document.getElementById('app-container').style.display = 'flex';
            
            showView(location.hash.substring(1) || 'home');

            let isFirstLoad = true;
            unsubscribeClient = onSnapshot(doc(db, 'clients', clientId), async (docSnap) => {
                if (docSnap.exists()) {
                    let clientData = { id: docSnap.id, ...docSnap.data() };

                    // --- INICIO DE LA REPARACIÓN ---
                    // Capa de Compatibilidad y Saneamiento de Datos
                    if (!clientData.loans && clientData.totalLoan) {
                        console.warn("[CLIENTE-APP] Estructura de datos antigua detectada. Adaptando a la nueva estructura multi-préstamo.");
                        clientData.loans = [{
                            totalLoan: clientData.totalLoan,
                            paid: clientData.paid || 0,
                            installments: clientData.installments,
                            originalInstallmentAmount: clientData.amount, // CORRECCIÓN: Usar 'amount' del formato antiguo
                            startDate: clientData.startDate,
                            history: clientData.history || [],
                            paymentBalance: clientData.paymentBalance || 0,
                        }];
                    } else if (!clientData.loans) {
                        clientData.loans = [];
                    }

                    // Saneamiento: Asegura que todos los préstamos tengan los campos necesarios y el status correcto
                    clientData.loans.forEach(loan => {
                        // 1. Asegura que 'totalInstallments' exista para la barra de progreso
                        if (loan.installments && typeof loan.totalInstallments === 'undefined') {
                            loan.totalInstallments = (loan.installments.split('/')[1] || 0) * 1;
                        }
                        // 2. Calcula y asigna el status dinámicamente para el filtro de pestañas
                        const isFinished = (loan.paid || 0) >= (loan.totalLoan || 0) && (loan.totalLoan > 0);
                        loan.status = isFinished ? 'finished' : 'active';
                    });
                    // --- FIN DE LA REPARACIÓN ---
                    
                    currentClient = clientData;
                    
                    // Cargar la configuración del cobrador ANTES de renderizar las vistas
                    if (currentClient.collectorId && !collectorSettings) {
                        try {
                            const collectorDoc = await getDoc(doc(db, 'collectors', currentClient.collectorId));
                            if (collectorDoc.exists()) {
                                collectorSettings = collectorDoc.data();
                            }
                        } catch(e) { console.error("Error fetching collector settings", e); }
                    }

                    updateAllViews();
                    if (isFirstLoad) {
                        console.log('[CLIENTE-APP] Primera carga del cliente. Iniciando verificaciones y setup de FCM.');
                        checkAndSendLatePaymentNotifications();
                        notificationInterval = setInterval(checkAndSendLatePaymentNotifications, 12 * 60 * 60 * 1000);
                        console.log('[CLIENTE-APP] Verificador de notificaciones configurado para ejecutarse cada 12 horas.');
                        
                        if ('serviceWorker' in navigator) {
                            navigator.serviceWorker.ready.then(registration => {
                                console.log('[CLIENTE-APP] Service Worker está activo. Procediendo a configurar FCM.');
                                setupFCM();
                            }).catch(err => {
                                console.error('[CLIENTE-APP] ERROR: El Service Worker no estuvo listo, no se pudo configurar FCM.', err);
                            });
                        } else {
                            console.error('[CLIENTE-APP] ERROR: Service Worker no es soportado por el navegador.');
                        }

                        isFirstLoad = false;
                    }
                } else {
                    showToast(translations[currentLang].accountNotFound, true);
                    handleLogout();
                }
            }, (error) => {
                console.error("Error catastrófico en onSnapshot del cliente:", error);
                showToast(translations[currentLang].dataLoadError, true);
                handleLogout();
            });
        }
        
        function showCropperModal(file) {
            const cropperModal = document.getElementById('cropperModal');
            cropperModal.innerHTML = `
                <header class="modal-header"><button id="closeCropperModal"><i data-lucide="x"></i></button><span class="modal-title" data-lang-key="cropImage"></span></header>
                <div class="modal-content-wrapper"><div id="cropper-container" class="container"><img id="cropper-image"></div></div>
                <div class="action-buttons">
                    <button class="btn-secondary" id="cancelCropBtn"><span data-lang-key="cancel"></span></button>
                    <button class="btn-primary" id="confirmCropBtn"><i data-lucide="check"></i> <span data-lang-key="confirmCrop"></span></button>
                </div>`;
            cropperModal.classList.add('active');
            lucide.createIcons({nodes: cropperModal.querySelectorAll('[data-lucide]')});
            applyLanguage(currentLang);
            
            const image = document.getElementById('cropper-image');
            const reader = new FileReader();
            let cropper;
            reader.onload = e => {
                image.src = e.target.result;
                cropper = new Cropper(image, { aspectRatio: 1, viewMode: 1, background: false });
            };
            reader.readAsDataURL(file);

            const closeModal = () => cropperModal.classList.remove('active');
            document.getElementById('closeCropperModal').addEventListener('click', closeModal);
            document.getElementById('cancelCropBtn').addEventListener('click', closeModal);

            document.getElementById('confirmCropBtn').addEventListener('click', () => {
                cropper.getCroppedCanvas({ width: 256, height: 256, imageSmoothingQuality: 'high' }).toBlob(async blob => {
                    const profileViewImg = document.getElementById('profile-view-img');
                    profileViewImg.classList.add('loading');
                    closeModal();
                    try {
                        const formData = new FormData();
                        formData.append('file', blob);
                        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                        const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                        if (!response.ok) throw new Error('Upload failed');
                        const data = await response.json();
                        await updateDoc(doc(db, 'clients', currentClient.id), { profilePictureUrl: data.secure_url });
                        showToast(translations[currentLang].picUpdateSuccess);
                    } catch (error) {
                        console.error("Profile picture update error:", error);
                        showToast(translations[currentLang].picUpdateError, true);
                    } finally {
                        profileViewImg.classList.remove('loading');
                    }
                }, 'image/jpeg');
            });
        }
        
        async function handleClearNotifications() {
            if (!currentClient) return;
            try {
                const clientRef = doc(db, 'clients', currentClient.id);
                await updateDoc(clientRef, {
                    notifications: []
                });
                showToast(translations[currentLang].notificationsCleared);
            } catch (error) {
                console.error("Error clearing notifications:", error);
                showToast(translations[currentLang].genericError, true);
            }
        }
        
        function copyToClipboard(text, message) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast(message || translations[currentLang].copied);
                } else {
                    showToast('Falha ao copiar.', true);
                }
            } catch (err) {
                showToast('Falha ao copiar.', true);
            }
            document.body.removeChild(textArea);
        }

        function setupEventListeners() {
            const appContainer = document.getElementById('app-container');
            if(!appContainer) return;

            appContainer.addEventListener('click', e => {
                const target = e.target;
                if (target.closest('#theme-toggle')) {
                    const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                }
                if (target.closest('#header-profile-link')) {
                    location.hash = 'profile';
                }
                const langToggle = document.getElementById('lang-toggle');
                const langDropdown = document.getElementById('lang-dropdown');
                if (langToggle && target.closest('#lang-toggle')) {
                    langDropdown.style.display = langDropdown.style.display === 'block' ? 'none' : 'block';
                } else if(langDropdown) {
                    langDropdown.style.display = 'none';
                }
                
                const langButton = target.closest('[data-lang]');
                if (langButton) {
                    const newLang = langButton.dataset.lang;
                    localStorage.setItem('language', newLang);
                    currentLang = newLang; // Actualiza la variable global PRIMERO
                    updateAllViews();      // LUEGO, refresca todas las vistas (incluido el historial)
                    
                    if (langDropdown) langDropdown.style.display = 'none';
                }

                const loanTab = target.closest('.loan-tab');
                if (loanTab && loanTab.dataset.index) {
                    const newIndex = parseInt(loanTab.dataset.index, 10);
                    if (newIndex !== selectedLoanIndex) {
                        selectedLoanIndex = newIndex;
                        updateAllViews();
                    }
                }

                const navItem = target.closest('.nav-item');
                if (navItem) {
                    if (navItem.classList.contains('disabled')) {
                        showToast(translations[currentLang].loanFinished);
                        return;
                    }
                    const targetView = navItem.dataset.view;
                    location.hash = targetView;
                }
                if(target.closest('#logout-btn')) handleLogout();
                
                if(target.closest('#test-push-btn')) {
                    console.log('[CLIENTE-APP] Botón de Test PUSH presionado. Enviando notificación de prueba...');
                    sendNotificationTicket('Notificación de Prueba', 'Si recibes esto, ¡las notificaciones PUSH funcionan!', 'test', 'check-circle');
                    showToast('Notificación de prueba enviada. Pon la app en segundo plano para verla.');
                }
                
                if(target.closest('#clear-notifications-btn')) {
                    handleClearNotifications();
                }

                const copyButton = target.closest('.copy-btn');
                if(copyButton && copyButton.dataset.copy) {
                    copyToClipboard(copyButton.dataset.copy, translations[currentLang].copied);
                }
                
                if(target.closest('#submit-receipt-btn')) {
                    handleReceiptSubmission(target.closest('#submit-receipt-btn'));
                }

                const notifItem = target.closest('.notification-item.unread');
                if (notifItem && notifItem.dataset.id) {
                    const notifId = notifItem.dataset.id;
                    if (currentClient) {
                        const clientRef = doc(db, 'clients', currentClient.id);
                        const updatedNotifications = currentClient.notifications.map((n, index) => {
                            const currentNotifId = n.id || `notif_${index}`;
                            if (currentNotifId === notifId) {
                                return { ...n, read: true };
                            }
                            return n;
                        });
                        updateDoc(clientRef, { notifications: updatedNotifications })
                            .then(() => showToast(translations[currentLang].notificationRead))
                            .catch(err => console.error("Error marking notification as read", err));
                    }
                }
            });
            appContainer.addEventListener('change', e => {
                if (e.target.id === 'profile-pic-input' && e.target.files && e.target.files[0]) {
                    showCropperModal(e.target.files[0]);
                }
                if (e.target.id === 'receipt-file-input' && e.target.files && e.target.files[0]) {
                    receiptFile = e.target.files[0];
                    const preview = document.getElementById('receipt-preview');
                    const uploadLabel = document.getElementById('upload-label-text');
                    preview.src = URL.createObjectURL(receiptFile);
                    preview.style.display = 'block';
                    uploadLabel.style.display = 'none';
                    document.getElementById('submit-receipt-btn').disabled = false;
                }
            });
        }
        async function sendNotificationToCollector(title, body, type = 'payment') {
            if (!currentClient || !currentClient.collectorId) return;
            try {
                const notificationsCollectionRef = collection(db, 'collectors', currentClient.collectorId, 'notifications');
                await addDoc(notificationsCollectionRef, {
                    title: title,
                    body: body,
                    from: currentClient.name,
                    clientId: currentClient.id,
                    timestamp: serverTimestamp(),
                    read: false,
                    type: type,
                    profilePictureUrl: currentClient.profilePictureUrl || ''
                });
                console.log("Ticket de notificação push enviado ao servidor para o cobrador.");
            } catch (error) {
                console.error("Error al enviar el ticket de notificación al cobrador:", error);
            }
        }
        async function handleReceiptSubmission(button) {
             if (!receiptFile || !currentClient) return;
             
             const amountInput = document.getElementById('receipt-amount');
             const amount = parseFloat(amountInput.value);

             if (isNaN(amount) || amount <= 0) {
                 showToast(translations[currentLang].invalidAmount, true);
                 return;
             }

             const originalButtonHTML = button.innerHTML;
             button.disabled = true;
             button.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i>`;
             lucide.createIcons({nodes: [button.querySelector('i')]});
             
             try {
                const formData = new FormData();
                formData.append('file', receiptFile);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Upload to Cloudinary failed: ${response.statusText} - ${errorText}`);
                }
                const data = await response.json();
                
                const clientRef = doc(db, 'clients', currentClient.id);
                
                // Crea una copia profunda para modificar el array de préstamos de forma segura
                const updatedLoans = JSON.parse(JSON.stringify(currentClient.loans));
                const newPayment = {
                    amount: amount,
                    date: new Date(),
                    receiptUrl: data.secure_url,
                    status: 'pending_verification'
                };
                
                if (!updatedLoans[selectedLoanIndex].history) {
                    updatedLoans[selectedLoanIndex].history = [];
                }
                updatedLoans[selectedLoanIndex].history.push(newPayment);

                await updateDoc(clientRef, {
                    loans: updatedLoans
                });

                showToast(translations[currentLang].receiptSent);
                sendNotificationToCollector(`${currentClient.name}`, `${translations[currentLang].paymentSent} ${money(amount)}.`, 'payment');
                
                receiptFile = null;
                document.getElementById('receipt-file-input').value = '';
                document.getElementById('receipt-preview').style.display = 'none';
                document.getElementById('upload-label-text').style.display = 'block';
                amountInput.value = '';
                button.disabled = true;
                
                button.innerHTML = originalButtonHTML;
                
                document.querySelector('.nav-item[data-view="home"]').click();

             } catch(error) {
                console.error("Receipt submission error:", error);
                showToast(translations[currentLang].uploadError, true);
                button.disabled = false;
                button.innerHTML = originalButtonHTML;
                lucide.createIcons({nodes: button.querySelectorAll('[data-lucide]')});
             }
        }

        function loadGlobalSettings(settings) {
            const companyLogo = settings.companyLogo || DEFAULT_LOGO_URL;
            document.getElementById('splash-logo').src = companyLogo;
            document.getElementById('login-logo').src = companyLogo;
            const headerLogo = document.getElementById('header-logo');
            if(headerLogo) headerLogo.src = companyLogo;
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.querySelector('#login-form button');
            const originalBtnHTML = loginBtn.innerHTML;
            loginBtn.disabled = true;
            loginBtn.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i>`;
            lucide.createIcons({nodes: [loginBtn.querySelector('i')]});

            try {
                const q = query(collection(db, "clients"), where("username", "==", username), where("password", "==", password));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showToast(translations[currentLang].invalidCredentials, true);
                } else {
                    const clientDoc = querySnapshot.docs[0];
                    sessionStorage.setItem('lumixClientId', clientDoc.id);
                    document.getElementById('login-form').removeEventListener('submit', handleLogin);
                    showMainApp(clientDoc.id);
                }
            } catch (error) {
                console.error("Login error:", error);
                showToast(translations[currentLang].genericError, true);
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = originalBtnHTML;
                applyLanguage(currentLang);
            }
        }

        function init() {
            if ('serviceWorker' in navigator) {
              if (location.protocol === 'https:' || location.hostname === 'localhost') {
                navigator.serviceWorker.register('firebase-messaging-sw.js')
                  .then(function(registration) {
                    console.log('Service Worker registrado con éxito:', registration);
                  }).catch(function(error) {
                    console.log('Error al registrar el Service Worker:', error);
                  });
              } else {
                  console.warn('Service Worker no registrado. El entorno no es seguro (HTTPS) o no es localhost.');
              }
            }

            window.addEventListener('popstate', () => {
                if (currentClient) {
                    const viewName = location.hash.substring(1) || 'home';
                    showView(viewName);
                }
            });

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                const installBanner = document.getElementById('install-banner');
                if (installBanner) installBanner.style.display = 'block';
            });

            const installBtn = document.getElementById('install-btn');
            if (installBtn) {
                installBtn.addEventListener('click', async () => {
                    const installBanner = document.getElementById('install-banner');
                    if (installBanner) installBanner.style.display = 'none';
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log(`User response to the install prompt: ${outcome}`);
                        deferredPrompt = null;
                    }
                });
            }

            const closeInstallBtn = document.getElementById('close-install-banner');
			if (closeInstallBtn) {
				closeInstallBtn.addEventListener('click', () => {
					const installBanner = document.getElementById('install-banner');
					if (installBanner) installBanner.style.display = 'none';
				});
			}

            const preferredTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(preferredTheme);
            applyLanguage(currentLang);
            
            onSnapshot(doc(db, 'config', 'global'), (docSnap) => {
                loadGlobalSettings(docSnap.exists() ? docSnap.data() : {});
            });

            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.style.display = 'none';
                    const loggedInClientId = sessionStorage.getItem('lumixClientId');
                    if (loggedInClientId) {
                        showMainApp(loggedInClientId);
                    } else {
                        document.getElementById('login-view').style.display = 'flex';
                        document.getElementById('login-form').addEventListener('submit', handleLogin);
                    }
                }, 500);
            }, 1500);
        }
        init();
    </script>
</body>
</html>
